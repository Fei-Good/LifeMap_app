<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CocosÊ∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #gameContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
        }
        
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
        }
        
        .loading-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .loading-text {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00f5ff, #00d4ff);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 100;
            pointer-events: none;
        }
        
        .ui-element {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .score { background: rgba(255, 149, 0, 0.9); }
        .level { background: rgba(0, 122, 255, 0.9); }
        .lives { background: rgba(255, 59, 48, 0.9); }
        
        .game-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .control-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.95);
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- Âä†ËΩΩÁïåÈù¢ -->
        <div id="loadingScreen" class="loading">
            <div class="loading-logo">üéÆ</div>
            <div class="loading-text">Ê∏∏ÊàèÂä†ËΩΩ‰∏≠...</div>
            <div class="loading-progress">
                <div id="progressBar" class="progress-bar"></div>
            </div>
        </div>
        
        <!-- Ê∏∏ÊàèÁîªÂ∏É -->
        <canvas id="gameCanvas" class="hidden"></canvas>
        
        <!-- Ê∏∏ÊàèUI -->
        <div id="gameUI" class="game-ui hidden">
            <span id="scoreDisplay" class="ui-element score">ÂæóÂàÜ: 0</span>
            <span id="levelDisplay" class="ui-element level">Á≠âÁ∫ß: 1</span>
            <span id="livesDisplay" class="ui-element lives">ÁîüÂëΩ: 3</span>
        </div>
        
        <!-- Ê∏∏ÊàèÊéßÂà∂ -->
        <div id="gameControls" class="game-controls hidden">
            <button id="pauseBtn" class="control-btn">ÊöÇÂÅú</button>
            <button id="restartBtn" class="control-btn">ÈáçÊñ∞ÂºÄÂßã</button>
        </div>
    </div>

    <script>
        /**
         * Â∞èÁ®ãÂ∫è‰∏éCocosÊ∏∏ÊàèÈÄö‰ø°Ê°•Êé•
         */
        class GameBridge {
            constructor() {
                this.game = null;
                this.gameData = {
                    score: 0,
                    level: 1,
                    lives: 3,
                    paused: false
                };
                this.settings = {};
                this.callbacks = {};
                
                this.init();
            }
            
            init() {
                // Ëß£ÊûêURLÂèÇÊï∞
                this.parseUrlParams();
                
                // ÂàùÂßãÂåñÊ∏∏Êàè
                this.initGame();
                
                // ÁªëÂÆö‰∫ã‰ª∂
                this.bindEvents();
                
                // Ê®°ÊãüÊ∏∏ÊàèÂä†ËΩΩ
                this.simulateLoading();
            }
            
            parseUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                this.userId = urlParams.get('userId') || 'guest';
                this.userLevel = parseInt(urlParams.get('userLevel')) || 1;
                
                try {
                    this.settings = JSON.parse(urlParams.get('settings') || '{}');
                } catch (error) {
                    console.error('Ëß£ÊûêËÆæÁΩÆÂèÇÊï∞Â§±Ë¥•:', error);
                    this.settings = {};
                }
                
                console.log('Ê∏∏ÊàèÂèÇÊï∞:', { 
                    userId: this.userId, 
                    userLevel: this.userLevel, 
                    settings: this.settings 
                });
            }
            
            initGame() {
                // ËøôÈáåÂàùÂßãÂåñ‰Ω†ÁöÑCocosÊ∏∏Êàè
                // Â¶ÇÊûú‰ΩøÁî®Cocos CreatorÔºåÈÄöÂ∏∏ÊòØËøôÊ†∑Ôºö
                /*
                cc.game.onStart = () => {
                    cc.director.loadScene('MainScene');
                };
                cc.game.run();
                */
                
                // Ê®°ÊãüÊ∏∏ÊàèÂàùÂßãÂåñ
                console.log('Ê∏∏ÊàèÂàùÂßãÂåñ‰∏≠...');
            }
            
            simulateLoading() {
                let progress = 0;
                const progressBar = document.getElementById('progressBar');
                
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        setTimeout(() => this.onGameReady(), 500);
                    }
                    progressBar.style.width = progress + '%';
                }, 200);
            }
            
            onGameReady() {
                // ÈöêËóèÂä†ËΩΩÁïåÈù¢
                document.getElementById('loadingScreen').classList.add('hidden');
                
                // ÊòæÁ§∫Ê∏∏ÊàèÁïåÈù¢
                document.getElementById('gameCanvas').classList.remove('hidden');
                document.getElementById('gameUI').classList.remove('hidden');
                document.getElementById('gameControls').classList.remove('hidden');
                
                // ÈÄöÁü•Â∞èÁ®ãÂ∫èÊ∏∏ÊàèÂ∑≤ÂáÜÂ§áÂ∞±Áª™
                this.sendMessageToMiniProgram({
                    type: 'gameStart',
                    payload: {
                        userId: this.userId,
                        timestamp: Date.now()
                    }
                });
                
                // ÂºÄÂßãÊ∏∏ÊàèÂæ™ÁéØÔºàÁ§∫‰æãÔºâ
                this.startGameLoop();
            }
            
            startGameLoop() {
                // Ê®°ÊãüÊ∏∏ÊàèÈÄªËæë
                setInterval(() => {
                    if (!this.gameData.paused) {
                        // Ê®°ÊãüÂæóÂàÜÂ¢ûÈïø
                        this.gameData.score += Math.floor(Math.random() * 10);
                        this.updateUI();
                        
                        // ÊØè1000ÂàÜÂçáÁ∫ß
                        if (this.gameData.score > this.gameData.level * 1000) {
                            this.gameData.level++;
                            this.onLevelUp();
                        }
                    }
                }, 1000);
            }
            
            updateUI() {
                document.getElementById('scoreDisplay').textContent = `ÂæóÂàÜ: ${this.gameData.score}`;
                document.getElementById('levelDisplay').textContent = `Á≠âÁ∫ß: ${this.gameData.level}`;
                document.getElementById('livesDisplay').textContent = `ÁîüÂëΩ: ${this.gameData.lives}`;
                
                // ÈÄöÁü•Â∞èÁ®ãÂ∫èÊõ¥Êñ∞Êï∞ÊçÆ
                this.sendMessageToMiniProgram({
                    type: 'scoreUpdate',
                    payload: this.gameData
                });
            }
            
            onLevelUp() {
                console.log('ÂçáÁ∫ßÂà∞Á≠âÁ∫ß:', this.gameData.level);
                // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÂçáÁ∫ßÁâπÊïà
            }
            
            bindEvents() {
                // ÊöÇÂÅúÊåâÈíÆ
                document.getElementById('pauseBtn').addEventListener('click', () => {
                    this.togglePause();
                });
                
                // ÈáçÊñ∞ÂºÄÂßãÊåâÈíÆ
                document.getElementById('restartBtn').addEventListener('click', () => {
                    this.restartGame();
                });
                
                // ÁõëÂê¨Â∞èÁ®ãÂ∫èÊ∂àÊÅØÔºàÂ¶ÇÊûúÊîØÊåÅÔºâ
                window.addEventListener('message', (event) => {
                    this.handleMessageFromMiniProgram(event.data);
                });
                
                // ÁõëÂê¨È°µÈù¢ÂèØËßÅÊÄßÂèòÂåñ
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pause();
                    }
                });
            }
            
            togglePause() {
                this.gameData.paused = !this.gameData.paused;
                const pauseBtn = document.getElementById('pauseBtn');
                pauseBtn.textContent = this.gameData.paused ? 'ÁªßÁª≠' : 'ÊöÇÂÅú';
                
                this.sendMessageToMiniProgram({
                    type: 'gamePause',
                    payload: { paused: this.gameData.paused }
                });
            }
            
            pause() {
                this.gameData.paused = true;
                document.getElementById('pauseBtn').textContent = 'ÁªßÁª≠';
            }
            
            resume() {
                this.gameData.paused = false;
                document.getElementById('pauseBtn').textContent = 'ÊöÇÂÅú';
            }
            
            restartGame() {
                this.gameData = {
                    score: 0,
                    level: 1,
                    lives: 3,
                    paused: false
                };
                this.updateUI();
                
                this.sendMessageToMiniProgram({
                    type: 'gameRestart',
                    payload: this.gameData
                });
            }
            
            endGame() {
                this.sendMessageToMiniProgram({
                    type: 'gameEnd',
                    payload: {
                        score: this.gameData.score,
                        level: this.gameData.level,
                        duration: Date.now() - this.startTime,
                        timestamp: Date.now()
                    }
                });
            }
            
            sendMessageToMiniProgram(message) {
                try {
                    // Â∞èÁ®ãÂ∫èwebviewÈÄö‰ø°ÊñπÂºè
                    if (window.wx && window.wx.miniProgram) {
                        wx.miniProgram.postMessage({
                            data: JSON.stringify(message)
                        });
                    }
                    
                    // ÂÖ∂‰ªñÂπ≥Âè∞ÁöÑÈÄö‰ø°ÊñπÂºè
                    if (window.parent !== window) {
                        window.parent.postMessage(message, '*');
                    }
                    
                    console.log('ÂèëÈÄÅÊ∂àÊÅØÂà∞Â∞èÁ®ãÂ∫è:', message);
                } catch (error) {
                    console.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error);
                }
            }
            
            handleMessageFromMiniProgram(data) {
                try {
                    const message = typeof data === 'string' ? JSON.parse(data) : data;
                    
                    switch (message.type) {
                        case 'pause':
                            if (message.payload.paused) {
                                this.pause();
                            } else {
                                this.resume();
                            }
                            break;
                        case 'restart':
                            this.restartGame();
                            break;
                        case 'updateSettings':
                            this.settings = { ...this.settings, ...message.payload };
                            break;
                        default:
                            console.log('Êú™Áü•Ê∂àÊÅØÁ±ªÂûã:', message.type);
                    }
                } catch (error) {
                    console.error('Â§ÑÁêÜÂ∞èÁ®ãÂ∫èÊ∂àÊÅØÂ§±Ë¥•:', error);
                }
            }
        }
        
        // ÂàùÂßãÂåñÊ∏∏ÊàèÊ°•Êé•
        const gameBridge = new GameBridge();
        
        // ÂÖ®Â±ÄÊö¥Èú≤Ê∏∏ÊàèÊ°•Êé•Ôºà‰æõCocosÊ∏∏ÊàèË∞ÉÁî®Ôºâ
        window.gameBridge = gameBridge;
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁöÑÂ§ÑÁêÜ
        window.addEventListener('load', () => {
            console.log('Ê∏∏ÊàèÈ°µÈù¢Âä†ËΩΩÂÆåÊàê');
        });
        
        // È°µÈù¢Âç∏ËΩΩÂâçÁöÑÂ§ÑÁêÜ
        window.addEventListener('beforeunload', () => {
            // ‰øùÂ≠òÊ∏∏ÊàèÁä∂ÊÄÅ
            gameBridge.endGame();
        });
    </script>
</body>
</html>
