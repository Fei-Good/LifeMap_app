<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cocos游戏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #gameContainer {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            background: #000;
        }
        
        .loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
        }
        
        .loading-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .loading-text {
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .loading-progress {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00f5ff, #00d4ff);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 100;
            pointer-events: none;
        }
        
        .ui-element {
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .score { background: rgba(255, 149, 0, 0.9); }
        .level { background: rgba(0, 122, 255, 0.9); }
        .lives { background: rgba(255, 59, 48, 0.9); }
        
        .game-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .control-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.95);
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- 加载界面 -->
        <div id="loadingScreen" class="loading">
            <div class="loading-logo">🎮</div>
            <div class="loading-text">游戏加载中...</div>
            <div class="loading-progress">
                <div id="progressBar" class="progress-bar"></div>
            </div>
        </div>
        
        <!-- 游戏画布 -->
        <canvas id="gameCanvas" class="hidden"></canvas>
        
        <!-- 游戏UI -->
        <div id="gameUI" class="game-ui hidden">
            <span id="scoreDisplay" class="ui-element score">得分: 0</span>
            <span id="levelDisplay" class="ui-element level">等级: 1</span>
            <span id="livesDisplay" class="ui-element lives">生命: 3</span>
        </div>
        
        <!-- 游戏控制 -->
        <div id="gameControls" class="game-controls hidden">
            <button id="pauseBtn" class="control-btn">暂停</button>
            <button id="restartBtn" class="control-btn">重新开始</button>
        </div>
    </div>

    <script>
        /**
         * 小程序与Cocos游戏通信桥接
         */
        class GameBridge {
            constructor() {
                this.game = null;
                this.gameData = {
                    score: 0,
                    level: 1,
                    lives: 3,
                    paused: false
                };
                this.settings = {};
                this.callbacks = {};
                
                this.init();
            }
            
            init() {
                // 解析URL参数
                this.parseUrlParams();
                
                // 初始化游戏
                this.initGame();
                
                // 绑定事件
                this.bindEvents();
                
                // 模拟游戏加载
                this.simulateLoading();
            }
            
            parseUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                this.userId = urlParams.get('userId') || 'guest';
                this.userLevel = parseInt(urlParams.get('userLevel')) || 1;
                
                try {
                    this.settings = JSON.parse(urlParams.get('settings') || '{}');
                } catch (error) {
                    console.error('解析设置参数失败:', error);
                    this.settings = {};
                }
                
                console.log('游戏参数:', { 
                    userId: this.userId, 
                    userLevel: this.userLevel, 
                    settings: this.settings 
                });
            }
            
            initGame() {
                // 这里初始化你的Cocos游戏
                // 如果使用Cocos Creator，通常是这样：
                /*
                cc.game.onStart = () => {
                    cc.director.loadScene('MainScene');
                };
                cc.game.run();
                */
                
                // 模拟游戏初始化
                console.log('游戏初始化中...');
            }
            
            simulateLoading() {
                let progress = 0;
                const progressBar = document.getElementById('progressBar');
                
                const interval = setInterval(() => {
                    progress += Math.random() * 15;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        setTimeout(() => this.onGameReady(), 500);
                    }
                    progressBar.style.width = progress + '%';
                }, 200);
            }
            
            onGameReady() {
                // 隐藏加载界面
                document.getElementById('loadingScreen').classList.add('hidden');
                
                // 显示游戏界面
                document.getElementById('gameCanvas').classList.remove('hidden');
                document.getElementById('gameUI').classList.remove('hidden');
                document.getElementById('gameControls').classList.remove('hidden');
                
                // 通知小程序游戏已准备就绪
                this.sendMessageToMiniProgram({
                    type: 'gameStart',
                    payload: {
                        userId: this.userId,
                        timestamp: Date.now()
                    }
                });
                
                // 开始游戏循环（示例）
                this.startGameLoop();
            }
            
            startGameLoop() {
                // 模拟游戏逻辑
                setInterval(() => {
                    if (!this.gameData.paused) {
                        // 模拟得分增长
                        this.gameData.score += Math.floor(Math.random() * 10);
                        this.updateUI();
                        
                        // 每1000分升级
                        if (this.gameData.score > this.gameData.level * 1000) {
                            this.gameData.level++;
                            this.onLevelUp();
                        }
                    }
                }, 1000);
            }
            
            updateUI() {
                document.getElementById('scoreDisplay').textContent = `得分: ${this.gameData.score}`;
                document.getElementById('levelDisplay').textContent = `等级: ${this.gameData.level}`;
                document.getElementById('livesDisplay').textContent = `生命: ${this.gameData.lives}`;
                
                // 通知小程序更新数据
                this.sendMessageToMiniProgram({
                    type: 'scoreUpdate',
                    payload: this.gameData
                });
            }
            
            onLevelUp() {
                console.log('升级到等级:', this.gameData.level);
                // 可以在这里添加升级特效
            }
            
            bindEvents() {
                // 暂停按钮
                document.getElementById('pauseBtn').addEventListener('click', () => {
                    this.togglePause();
                });
                
                // 重新开始按钮
                document.getElementById('restartBtn').addEventListener('click', () => {
                    this.restartGame();
                });
                
                // 监听小程序消息（如果支持）
                window.addEventListener('message', (event) => {
                    this.handleMessageFromMiniProgram(event.data);
                });
                
                // 监听页面可见性变化
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pause();
                    }
                });
            }
            
            togglePause() {
                this.gameData.paused = !this.gameData.paused;
                const pauseBtn = document.getElementById('pauseBtn');
                pauseBtn.textContent = this.gameData.paused ? '继续' : '暂停';
                
                this.sendMessageToMiniProgram({
                    type: 'gamePause',
                    payload: { paused: this.gameData.paused }
                });
            }
            
            pause() {
                this.gameData.paused = true;
                document.getElementById('pauseBtn').textContent = '继续';
            }
            
            resume() {
                this.gameData.paused = false;
                document.getElementById('pauseBtn').textContent = '暂停';
            }
            
            restartGame() {
                this.gameData = {
                    score: 0,
                    level: 1,
                    lives: 3,
                    paused: false
                };
                this.updateUI();
                
                this.sendMessageToMiniProgram({
                    type: 'gameRestart',
                    payload: this.gameData
                });
            }
            
            endGame() {
                this.sendMessageToMiniProgram({
                    type: 'gameEnd',
                    payload: {
                        score: this.gameData.score,
                        level: this.gameData.level,
                        duration: Date.now() - this.startTime,
                        timestamp: Date.now()
                    }
                });
            }
            
            sendMessageToMiniProgram(message) {
                try {
                    // 小程序webview通信方式
                    if (window.wx && window.wx.miniProgram) {
                        wx.miniProgram.postMessage({
                            data: JSON.stringify(message)
                        });
                    }
                    
                    // 其他平台的通信方式
                    if (window.parent !== window) {
                        window.parent.postMessage(message, '*');
                    }
                    
                    console.log('发送消息到小程序:', message);
                } catch (error) {
                    console.error('发送消息失败:', error);
                }
            }
            
            handleMessageFromMiniProgram(data) {
                try {
                    const message = typeof data === 'string' ? JSON.parse(data) : data;
                    
                    switch (message.type) {
                        case 'pause':
                            if (message.payload.paused) {
                                this.pause();
                            } else {
                                this.resume();
                            }
                            break;
                        case 'restart':
                            this.restartGame();
                            break;
                        case 'updateSettings':
                            this.settings = { ...this.settings, ...message.payload };
                            break;
                        default:
                            console.log('未知消息类型:', message.type);
                    }
                } catch (error) {
                    console.error('处理小程序消息失败:', error);
                }
            }
        }
        
        // 初始化游戏桥接
        const gameBridge = new GameBridge();
        
        // 全局暴露游戏桥接（供Cocos游戏调用）
        window.gameBridge = gameBridge;
        
        // 页面加载完成后的处理
        window.addEventListener('load', () => {
            console.log('游戏页面加载完成');
        });
        
        // 页面卸载前的处理
        window.addEventListener('beforeunload', () => {
            // 保存游戏状态
            gameBridge.endGame();
        });
    </script>
</body>
</html>
